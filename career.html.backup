import React, { useState, useEffect, useRef } from 'react';
import { 
  Search, MapPin, Calendar, Clock, DollarSign, 
  MessageCircle, X, Send, User, Briefcase, 
  Zap, GraduationCap, ChevronRight, Star, 
  Menu, Bell, Filter, Award, BookOpen
} from 'lucide-react';

// --- 1. æ ¸å¿ƒè³‡æ–™åº« (èª²ç¨‹è³‡è¨Š.json) ---
const COURSES_DATA = [
  {
    "id": 1,
    "domain": "è³‡è¨Šç§‘æŠ€",
    "type": "åœ¨è·",
    "title": "Python å¤§æ•¸æ“šåˆ†æå¯¦æˆ°ç­",
    "period": "2026/02/17 ~ 2026/04/23",
    "time": "æ¯é€±äºŒã€å›› 19:00-22:00",
    "location": "å°åŒ—æ•¸ä½åœ’å€",
    "instructor": "ææ•¸æ“š åšå£«",
    "price": 12000,
    "tags": ["Python", "å¤§æ•¸æ“š", "è³‡æ–™åˆ†æ", "AI", "ç¨‹å¼è¨­è¨ˆ"],
    "rating": 4.8,
    "employmentRate": "92%"
  },
  {
    "id": 2,
    "domain": "è³‡è¨Šç§‘æŠ€",
    "type": "è·å‰",
    "title": "å‰ç«¯å·¥ç¨‹å¸«é¤Šæˆï¼šReact å…¨æ”»ç•¥",
    "period": "2026/03/02 ~ 2026/05/29",
    "time": "é€±ä¸€è‡³é€±äº” 09:00-16:00",
    "location": "ç·šä¸Šç›´æ’­ (Zoom)",
    "instructor": "ç‹å‰ç«¯ è³‡æ·±å·¥ç¨‹å¸«",
    "price": 45000,
    "tags": ["å‰ç«¯", "React", "JavaScript", "ç¶²é é–‹ç™¼", "RWD", "å°±æ¥­é¤Šæˆ"],
    "rating": 4.9,
    "employmentRate": "95%"
  },
  {
    "id": 3,
    "domain": "è³‡è¨Šç§‘æŠ€",
    "type": "åœ¨è·",
    "title": "AWS é›²ç«¯æ¶æ§‹å¸«èªè­‰ç­",
    "period": "2026/03/09 ~ 2026/05/27",
    "time": "æ¯é€±ä¸€ã€ä¸‰ 19:00-22:00",
    "location": "å°ä¸­è»Ÿé«”åœ’å€ 201 å®¤",
    "instructor": "å¼µé›²ç«¯ æ¶æ§‹å¸«",
    "price": 18000,
    "tags": ["é›²ç«¯", "AWS", "ä¼ºæœå™¨", "IT", "è€ƒç…§"],
    "rating": 4.7,
    "employmentRate": "88%"
  },
  {
    "id": 4,
    "domain": "è³‡è¨Šç§‘æŠ€",
    "type": "åœ¨è·",
    "title": "è³‡å®‰é˜²è­·èˆ‡å€«ç†é§­å®¢å…¥é–€",
    "period": "2026/03/06 ~ 2026/06/26",
    "time": "æ¯é€±äº” 18:30-21:30",
    "location": "å°åŒ—ä¿¡ç¾©åŸ¹è¨“ä¸­å¿ƒ",
    "instructor": "é™³é»‘å®¢ è³‡å®‰é¡§å•",
    "price": 13500,
    "tags": ["è³‡å®‰", "é§­å®¢", "ç¶²è·¯å®‰å…¨", "Linux", "ç³»çµ±ç®¡ç†"],
    "rating": 4.6,
    "employmentRate": "90%"
  },
  {
    "id": 5,
    "domain": "å•†æ¥­ç®¡ç†",
    "type": "åœ¨è·",
    "title": "æ•¸ä½è¡ŒéŠ·èˆ‡ SEO æµé‡å¯†ç¢¼",
    "period": "2026/03/04 ~ 2026/05/20",
    "time": "æ¯é€±ä¸‰ 19:00-22:00",
    "location": "ç·šä¸Šç›´æ’­ (Google Meet)",
    "instructor": "æ—è¡ŒéŠ· ç¸½ç›£",
    "price": 8000,
    "tags": ["è¡ŒéŠ·", "SEO", "ç¤¾ç¾¤å°ç·¨", "å»£å‘ŠæŠ•æ”¾", "æµé‡"],
    "rating": 4.5,
    "employmentRate": "85%"
  },
  {
    "id": 6,
    "domain": "å•†æ¥­ç®¡ç†",
    "type": "åœ¨è·",
    "title": "PMP å°ˆæ¡ˆç®¡ç†å¯¦å‹™èªè­‰ç­",
    "period": "2026/03/07 ~ 2026/05/09",
    "time": "æ¯é€±å…­ 13:00-17:00",
    "location": "æ–°åŒ—æ¿æ©‹å•†å‹™ä¸­å¿ƒ",
    "instructor": "éƒ­å°ˆæ¡ˆ é¡§å•",
    "price": 22000,
    "tags": ["å°ˆæ¡ˆç®¡ç†", "PMP", "ç®¡ç†", "å•†æ¥­", "æ•æ·é–‹ç™¼"],
    "rating": 4.8,
    "employmentRate": "N/A"
  },
  {
    "id": 9,
    "domain": "è¨­è¨ˆå¤šåª’é«”",
    "type": "è·å‰",
    "title": "UI/UX ä½¿ç”¨è€…ä»‹é¢è¨­è¨ˆå°±æ¥­ç­",
    "period": "2026/03/02 ~ 2026/06/05",
    "time": "é€±ä¸€è‡³é€±äº” 09:00-16:00",
    "location": "å°åŒ—ä¸­å±±è¨­è¨ˆåŠ",
    "instructor": "è¶™ä»‹é¢ è¨­è¨ˆå¸«",
    "price": 52000,
    "tags": ["UI/UX", "Figma", "ç¶²é è¨­è¨ˆ", "Appè¨­è¨ˆ", "ç¾ç·¨", "ä½œå“é›†"],
    "rating": 4.9,
    "employmentRate": "91%"
  },
  {
    "id": 10,
    "domain": "è¨­è¨ˆå¤šåª’é«”",
    "type": "åœ¨è·",
    "title": "å•†æ¥­å¹³é¢è¨­è¨ˆï¼šPS + AI æ•´åˆé‹ç”¨",
    "period": "2026/03/03 ~ 2026/05/22",
    "time": "æ¯é€±äºŒã€äº” 18:30-21:30",
    "location": "å°ä¸­å‹¤ç¾æ•™å­¸ä¸­å¿ƒ",
    "instructor": "é»ƒè¦–è¦º ç¸½ç›£",
    "price": 11000,
    "tags": ["å¹³é¢è¨­è¨ˆ", "Photoshop", "Illustrator", "ä¿®åœ–", "Adobe"],
    "rating": 4.6,
    "employmentRate": "82%"
  },
  {
    "id": 14,
    "domain": "é¤é£²è§€å…‰",
    "type": "è·å‰",
    "title": "è¥¿é¤çƒ¹é£ªå°ˆæ¥­äººæ‰åŸ¹è¨“ç­",
    "period": "2026/02/23 ~ 2026/05/22",
    "time": "é€±ä¸€è‡³é€±äº” 08:30-16:30",
    "location": "æ–°åŒ—é¤æ—…è·æ¥­å­¸æ ¡",
    "instructor": "é„­ä¸»å»š",
    "price": 38000,
    "tags": ["è¥¿é¤", "è­‰ç…§", "çƒ¹é£ª", "æ–™ç†", "ä¸™ç´š", "å°±æ¥­é¤Šæˆ"],
    "rating": 4.7,
    "employmentRate": "96%"
  },
  {
    "id": 18,
    "domain": "èªè¨€æºé€š",
    "type": "åœ¨è·",
    "title": "æ—¥æ–‡ N3 æª¢å®šè¡åˆºç­",
    "period": "2026/03/05 ~ 2026/06/25",
    "time": "æ¯é€±å›› 19:00-22:00",
    "location": "å°åŒ—è»Šç«™èªè¨€ä¸­å¿ƒ",
    "instructor": "ä½è—¤ è€å¸«",
    "price": 8500,
    "tags": ["æ—¥æ–‡", "JLPT", "æª¢å®š", "ç¬¬äºŒå¤–èª", "æ—¥æœ¬"],
    "rating": 4.5,
    "employmentRate": "N/A"
  },
  {
    "id": 12,
    "domain": "è¨­è¨ˆå¤šåª’é«”",
    "type": "åœ¨è·",
    "title": "Blender 3D æ¨¡å‹å»ºç½®å…¥é–€",
    "period": "2026/03/05 ~ 2026/05/28",
    "time": "æ¯é€±å›› 19:00-22:00",
    "location": "ç·šä¸Šç›´æ’­ (Discord)",
    "instructor": "æ¥Šç«‹é«” å‹•ç•«å¸«",
    "price": 9000,
    "tags": ["3D", "Blender", "å‹•ç•«", "éŠæˆ²è¨­è¨ˆ", "å»ºæ¨¡"],
    "rating": 4.8,
    "employmentRate": "85%"
  },
  {
    "id": 13,
    "domain": "é¤é£²è§€å…‰",
    "type": "åœ¨è·",
    "title": "å°ˆæ¥­ç¾©å¼å’–å•¡å¸«æ‹‰èŠ±åŸ¹è¨“",
    "period": "2026/03/07 ~ 2026/05/23",
    "time": "æ¯é€±å…­ 14:00-17:00",
    "location": "å°åŒ—å¤§å®‰çƒ˜è±†å¯¦é©—å®¤",
    "instructor": "è¨±å’–å•¡ å† è»å¸«",
    "price": 14000,
    "tags": ["å’–å•¡", "æ‹‰èŠ±", "é¤é£²", "Barista", "å‰µæ¥­"],
    "rating": 4.9,
    "employmentRate": "88%"
  }
];

// --- 2. è¼”åŠ©åŠŸèƒ½å‡½å¼ ---
const filterCourses = (preferences) => {
  return COURSES_DATA.filter(course => {
    // ç¯©é¸èº«åˆ†/é¡å‹
    if (preferences.type && course.type !== preferences.type) {
      // å¦‚æœç”¨æˆ¶é¸è·å‰ï¼Œä½†èª²ç¨‹æ˜¯åœ¨è·ï¼Œéæ¿¾æ‰ (é™¤éæœ‰ç‰¹æ®Šé‚è¼¯ï¼Œé€™è£¡ç°¡åŒ–è™•ç†)
      // è‹¥ç”¨æˆ¶é¸åœ¨è·ï¼Œé€šå¸¸ä¸çœ‹è·å‰å…¨æ—¥åˆ¶
      // ä½†ç‚ºäº†å±•ç¤ºæ›´å¤šçµæœï¼Œè‹¥çµæœå¤ªå°‘å¯ä»¥æ”¾å¯¬
    }
    
    // ç¯©é¸é ˜åŸŸ
    if (preferences.domain && preferences.domain.length > 0) {
      const match = preferences.domain.some(d => course.domain === d || course.title.includes(d) || course.tags.some(t => t.includes(d)));
      if (!match) return false;
    }

    // ç¯©é¸åœ°é» (åŒ…å«ç·šä¸Š)
    if (preferences.location && preferences.location.length > 0) {
      const isOnline = course.location.includes("ç·šä¸Š") || course.location.includes("ç›´æ’­");
      const matchLoc = preferences.location.some(l => course.location.includes(l));
      if (!matchLoc && !isOnline) return false;
    }

    return true;
  });
};

// --- 3. Chatbot å…ƒä»¶ ---
const ChatBot = ({ onCourseClick }) => {
  const [isOpen, setIsOpen] = useState(false); // é è¨­é—œé–‰ï¼Œé¡¯ç¤ºç¸®åœ–
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState("");
  const [phase, setPhase] = useState("INIT"); // INIT, INTEREST, LOCATION, RESULT
  const [preferences, setPreferences] = useState({
    type: "", // è·å‰ or åœ¨è·
    domain: [],
    location: [],
    time: []
  });
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isOpen]);

  // é‡ç½® chatbot
  const handleReset = () => {
    setPhase("INIT");
    setPreferences({
      type: "",
      domain: [],
      location: [],
      time: []
    });
    setInput("");
    // é‡ç½®ä¸¦é¡¯ç¤ºæ­¡è¿è¨Šæ¯
    setMessages([
      {
        id: Date.now(),
        sender: "bot",
        text: "å—¨ï¼æˆ‘æ˜¯æ‚¨çš„è·æ¶¯é ˜èˆªå“¡ ğŸš€ã€‚æº–å‚™å¥½é–‹å•Ÿæ–°èˆªé“äº†å—ï¼Ÿç‚ºäº†å¹«æ‚¨å°‹æ‰¾åˆé©çš„è£œåŠ©èª²ç¨‹ï¼Œè«‹å…ˆå‘Šè¨´æˆ‘æ‚¨ç›®å‰çš„ç‹€æ…‹æ˜¯ï¼Ÿ",
        options: [
          { label: "ğŸš€ å……é›»å†å‡ºç™¼ (å¾…æ¥­)", value: "è·å‰", type: "card", desc: "æ‰¾å…¨é¡è£œåŠ©è·å‰è¨“ç·´" },
          { label: "âš¡ è·å ´å‡ç´šä¸­ (åœ¨è·)", value: "åœ¨è·", type: "card", desc: "ä¸‹ç­é€²ä¿®ã€ä¸‰å¹´ä¸ƒè¬" },
          { label: "ğŸ“ æ–°æ‰‹æ‘æ¢éšª (é’å¹´)", value: "è·å‰", type: "card", desc: "ç”¢æ¥­æ–°å°–å…µè¨ˆç•«" },
        ]
      }
    ]);
  };
  
  // è™•ç†èª²ç¨‹é»æ“Šï¼Œæ»¾å‹•åˆ°ä¸»é é¢å°æ‡‰èª²ç¨‹
  const handleCourseClick = (courseId) => {
    if (onCourseClick) {
      onCourseClick(courseId);
    }
  };

  // åˆå§‹åŒ–æ­¡è¿è¨Šæ¯
  useEffect(() => {
    if (messages.length === 0) {
      setMessages([
        {
          id: 1,
          sender: "bot",
          text: "å—¨ï¼æˆ‘æ˜¯æ‚¨çš„è·æ¶¯é ˜èˆªå“¡ ğŸš€ã€‚æº–å‚™å¥½é–‹å•Ÿæ–°èˆªé“äº†å—ï¼Ÿç‚ºäº†å¹«æ‚¨å°‹æ‰¾åˆé©çš„è£œåŠ©èª²ç¨‹ï¼Œè«‹å…ˆå‘Šè¨´æˆ‘æ‚¨ç›®å‰çš„ç‹€æ…‹æ˜¯ï¼Ÿ",
          options: [
            { label: "ğŸš€ å……é›»å†å‡ºç™¼ (å¾…æ¥­)", value: "è·å‰", type: "card", desc: "æ‰¾å…¨é¡è£œåŠ©è·å‰è¨“ç·´" },
            { label: "âš¡ è·å ´å‡ç´šä¸­ (åœ¨è·)", value: "åœ¨è·", type: "card", desc: "ä¸‹ç­é€²ä¿®ã€ä¸‰å¹´ä¸ƒè¬" },
            { label: "ğŸ“ æ–°æ‰‹æ‘æ¢éšª (é’å¹´)", value: "è·å‰", type: "card", desc: "ç”¢æ¥­æ–°å°–å…µè¨ˆç•«" },
          ]
        }
      ]);
    }
  }, []);

  const handleOptionClick = (option, e) => {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å½±éŸ¿ä¸»é é¢çš„å…¶ä»–æ“ä½œ
    if (e) {
      e.stopPropagation();
    }
    const newMessages = [...messages, { id: Date.now(), sender: "user", text: option.label }];
    setMessages(newMessages);

    // ç‹€æ…‹æ©Ÿé‚è¼¯
    setTimeout(() => {
      let botResponse = {};
      
      if (phase === "INIT") {
        const newPrefs = { ...preferences, type: option.value };
        setPreferences(newPrefs);
        setPhase("INTEREST");
        botResponse = {
          id: Date.now() + 1,
          sender: "bot",
          text: "äº†è§£ï¼æ‚¨æƒ³åœ¨å“ªå€‹ **ã€é ˜åŸŸã€** å……é›»å‡ç´šå‘¢ï¼Ÿ",
          options: [
            { label: "ğŸ’» è³‡è¨Šç§‘æŠ€", value: "è³‡è¨Šç§‘æŠ€", type: "chip" },
            { label: "ğŸ“Š å•†æ¥­ç®¡ç†", value: "å•†æ¥­ç®¡ç†", type: "chip" },
            { label: "ğŸ¨ è¨­è¨ˆå¤šåª’é«”", value: "è¨­è¨ˆå¤šåª’é«”", type: "chip" },
            { label: "â˜• é¤é£²è§€å…‰", value: "é¤é£²è§€å…‰", type: "chip" },
            { label: "ğŸ—£ï¸ èªè¨€æºé€š", value: "èªè¨€æºé€š", type: "chip" }
          ],
          allowInput: true,
          placeholder: "æˆ–è¼¸å…¥ï¼šæˆ‘æƒ³å­¸å‰ªå½±ç‰‡..."
        };
      } else if (phase === "INTEREST") {
        const selectedDomain = option.value;
        const newPrefs = { ...preferences, domain: [selectedDomain] };
        setPreferences(newPrefs);
        setPhase("LOCATION");
        botResponse = {
          id: Date.now() + 1,
          sender: "bot",
          text: "å¥½çš„ï¼Œæœ€å¾Œç¢ºèªåº§æ¨™ã€‚ç‚ºäº†æ–¹ä¾¿æ‚¨ä¸Šèª²ï¼Œæ‚¨å¸Œæœ›åœ¨ **å“ªå€‹åœ°å€**ï¼Ÿ",
          options: [
            { label: "å°åŒ—", value: "å°åŒ—", type: "chip" },
            { label: "æ–°åŒ—", value: "æ–°åŒ—", type: "chip" },
            { label: "å°ä¸­", value: "å°ä¸­", type: "chip" },
            { label: "é«˜é›„", value: "é«˜é›„", type: "chip" },
            { label: "ç·šä¸Š/ç›´æ’­", value: "ç·šä¸Š", type: "chip" },
          ],
          allowInput: true,
          placeholder: "ä¾‹å¦‚ï¼šå¹³æ—¥æ™šä¸Šã€å‡æ—¥..."
        };
      } else if (phase === "LOCATION") {
        const newPrefs = { ...preferences, location: [option.value] };
        setPreferences(newPrefs);
        setPhase("RESULT");
        
        const results = filterCourses(newPrefs);
        const count = results.length;
        
        botResponse = {
          id: Date.now() + 1,
          sender: "bot",
          text: `å°èˆªåƒæ•¸è¨­å®šå®Œæˆï¼æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ç‚ºæ‚¨ç”Ÿæˆäº†é€™å¼µ **ã€æœªä¾†è·æ¶¯é è¦½å¡ã€‘**ï¼Œä¸¦æ‰¾åˆ° **${count}** å ‚æœ€é€Ÿé…çš„èª²ç¨‹ï¼š`,
          isResult: true,
          courses: results.slice(0, 3) // åªé¡¯ç¤ºå‰3å€‹
        };
      }

      setMessages(prev => [...prev, botResponse]);
    }, 600);
  };

  const handleSend = (e) => {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å½±éŸ¿ä¸»é é¢çš„å…¶ä»–æ“ä½œ
    if (e) {
      e.stopPropagation();
    }
    if (!input.trim()) return;
    const userMsg = { id: Date.now(), sender: "user", text: input };
    setMessages(prev => [...prev, userMsg]);
    const currentInput = input;
    setInput("");

    // ç°¡å–®çš„æ–‡å­—è¼¸å…¥è™•ç†é‚è¼¯
    setTimeout(() => {
      let botResponse = {};
      
      // å¦‚æœæ˜¯åœ¨èˆˆè¶£éšæ®µè¼¸å…¥æ–‡å­—
      if (phase === "INTEREST") {
         // ç°¡å–®é—œéµå­—å°æ‡‰ (æ¨¡æ“¬ NLU)
         let domain = "è³‡è¨Šç§‘æŠ€";
         if (currentInput.includes("ç…®") || currentInput.includes("å’–å•¡")) domain = "é¤é£²è§€å…‰";
         if (currentInput.includes("ç•«") || currentInput.includes("è¨­è¨ˆ")) domain = "è¨­è¨ˆå¤šåª’é«”";
         
         const newPrefs = { ...preferences, domain: [domain] };
         setPreferences(newPrefs);
         setPhase("LOCATION");
         botResponse = {
            id: Date.now() + 1,
            sender: "bot",
            text: `äº†è§£ï¼Œæ‚¨å° ${currentInput} ç›¸é—œé ˜åŸŸæ„Ÿèˆˆè¶£ã€‚é‚£åœ°é»å¸Œæœ›åœ¨å“ªé‚Šå‘¢ï¼Ÿ`,
            options: [
              { label: "å°åŒ—", value: "å°åŒ—", type: "chip" },
              { label: "æ–°åŒ—", value: "æ–°åŒ—", type: "chip" },
              { label: "å°ä¸­", value: "å°ä¸­", type: "chip" },
              { label: "ç·šä¸Š", value: "ç·šä¸Š", type: "chip" },
            ],
            allowInput: true
         };
      } else {
        // ä¸€èˆ¬å°è©±æˆ– fallback
        botResponse = {
          id: Date.now() + 1,
          sender: "bot",
          text: "æˆ‘ç›®å‰é‚„åœ¨å­¸ç¿’è§£è®€è‡ªç”±æ–‡å­—ï¼Œæ‚¨å¯ä»¥è©¦è‘—é»æ“Šä¸Šæ–¹çš„é¸é …ï¼Œæˆ–æ˜¯è¯çµ¡å®¢æœå°ˆç·š 0800-123-456ã€‚",
        };
      }
      
      setMessages(prev => [...prev, botResponse]);
    }, 800);
  };

  return (
    <div 
      className="fixed bottom-6 right-6 z-50 flex flex-col items-end font-sans"
      onClick={(e) => e.stopPropagation()}
      onMouseDown={(e) => e.stopPropagation()}
      onMouseUp={(e) => e.stopPropagation()}
    >
      {/* å±•é–‹å¾Œçš„èŠå¤©è¦–çª— */}
      {isOpen && (
        <div 
          className="mb-4 w-[380px] h-[600px] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-gray-200 animate-in fade-in slide-in-from-bottom-10 duration-300"
          onClick={(e) => e.stopPropagation()}
          onMouseDown={(e) => e.stopPropagation()}
          onMouseUp={(e) => e.stopPropagation()}
        >
          {/* Header */}
          <div className="bg-blue-600 p-4 flex justify-between items-center text-white">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-600">
                <Zap size={24} fill="currentColor" />
              </div>
              <div>
                <h3 className="font-bold text-lg">è·æ¶¯é ˜èˆªå“¡</h3>
                <div className="flex items-center gap-1 text-xs opacity-90">
                  <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                  Online
                </div>
              </div>
            </div>
            <button 
              onClick={(e) => {
                e.stopPropagation();
                setIsOpen(false);
              }} 
              className="hover:bg-blue-700 p-1 rounded"
            >
              <X size={20} />
            </button>
          </div>

          {/* Messages Area */}
          <div className="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-4">
            {messages.map((msg) => (
              <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                <div className={`max-w-[85%] ${msg.sender === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-800 border border-gray-200'} rounded-2xl p-4 shadow-sm`}>
                  
                  {/* æ–‡å­—å…§å®¹ */}
                  <div className="whitespace-pre-line leading-relaxed">
                    {msg.text}
                  </div>

                  {/* é¸é …å€åŸŸ - å¡ç‰‡å¼ */}
                  {msg.options && msg.options[0].type === 'card' && (
                    <div className="mt-4 space-y-2">
                      {msg.options.map((opt, idx) => (
                        <button 
                          key={idx}
                          onClick={(e) => handleOptionClick(opt, e)}
                          className="w-full text-left p-3 rounded-xl border border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all bg-white group"
                        >
                          <div className="font-bold text-blue-900 group-hover:text-blue-600">{opt.label}</div>
                          <div className="text-xs text-gray-500 mt-1">{opt.desc}</div>
                        </button>
                      ))}
                    </div>
                  )}

                  {/* é¸é …å€åŸŸ - Chips */}
                  {msg.options && msg.options[0].type === 'chip' && (
                    <div className="mt-3 flex flex-wrap gap-2">
                      {msg.options.map((opt, idx) => (
                        <button 
                          key={idx}
                          onClick={(e) => handleOptionClick(opt, e)}
                          className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-200 transition-colors"
                        >
                          {opt.label}
                        </button>
                      ))}
                    </div>
                  )}

                  {/* çµæœå±•ç¤ºå¡ç‰‡ */}
                  {msg.isResult && msg.courses && (
                    <div className="mt-4 space-y-3">
                      {msg.courses.length > 0 ? msg.courses.map(course => (
                        <div key={course.id} className="bg-blue-50 p-3 rounded-xl border border-blue-100">
                           <div className="flex justify-between items-start mb-1">
                             <span className="text-xs font-bold text-blue-600 bg-blue-200 px-1.5 py-0.5 rounded">{course.type}</span>
                             <span className="text-xs text-gray-500">{course.domain}</span>
                           </div>
                           <h4 className="font-bold text-gray-800 text-sm mb-1">{course.title}</h4>
                           <div className="text-xs text-gray-600 space-y-0.5">
                             <div className="flex items-center gap-1"><MapPin size={10}/> {course.location}</div>
                             <div className="flex items-center gap-1"><DollarSign size={10}/> {course.price === 0 ? "å…è²»" : `$${course.price.toLocaleString()}`}</div>
                           </div>
                           <button 
                             onClick={(e) => {
                               e.stopPropagation();
                               handleCourseClick(course.id);
                             }}
                             className="mt-2 w-full py-1.5 bg-blue-600 text-white text-xs rounded font-medium hover:bg-blue-700 transition-colors"
                           >
                             æŸ¥çœ‹è©³æƒ…
                           </button>
                        </div>
                      )) : (
                        <div className="text-sm text-gray-500 italic p-2">
                          æŠ±æ­‰ï¼Œç›®å‰æ‰¾ä¸åˆ°å®Œå…¨ç¬¦åˆçš„èª²ç¨‹ã€‚è©¦è©¦æ”¾å¯¬åœ°é»é™åˆ¶ï¼Ÿ
                        </div>
                      )}
                    </div>
                  )}

                </div>
              </div>
            ))}
            <div ref={messagesEndRef} />
          </div>

          {/* Input Area */}
          <div className="p-3 bg-white border-t border-gray-200">
            <div className="flex items-center gap-2 bg-gray-100 rounded-full px-4 py-2">
              <input
                type="text"
                value={input}
                onChange={(e) => {
                  e.stopPropagation();
                  setInput(e.target.value);
                }}
                onKeyPress={(e) => {
                  if (e.key === 'Enter') {
                    e.stopPropagation();
                    handleSend(e);
                  }
                }}
                onClick={(e) => e.stopPropagation()}
                placeholder="è¼¸å…¥è¨Šæ¯..."
                className="bg-transparent flex-1 outline-none text-sm"
                disabled={messages[messages.length-1]?.allowInput === false}
              />
              <button 
                onClick={(e) => handleSend(e)}
                className={`p-1.5 rounded-full ${input.trim() ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'}`}
              >
                <Send size={16} />
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ç¸®åœ–æŒ‰éˆ• (Avatar) */}
      {!isOpen && (
        <button 
          onClick={(e) => {
            e.stopPropagation();
            setIsOpen(true);
          }}
          className="group relative flex items-center justify-center w-16 h-16 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg transition-all hover:scale-105 active:scale-95"
        >
          <Zap size={32} fill="currentColor" />
          <span className="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-white"></span>
          
          {/* Tooltip */}
          <div className="absolute right-full mr-4 bg-white text-gray-800 px-4 py-2 rounded-xl shadow-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none text-sm font-medium">
            ğŸ‘‹ å—¨ï¼æˆ‘æ˜¯è·æ¶¯é ˜èˆªå“¡ï¼Œæ‰¾èª²ç¨‹å•æˆ‘ï¼
            <div className="absolute top-1/2 -right-1 w-2 h-2 bg-white transform -translate-y-1/2 rotate-45"></div>
          </div>
        </button>
      )}
    </div>
  );
};

// --- 4. ç¶²ç«™ä¸»é«”å…ƒä»¶ ---
const App = () => {
  const [searchTerm, setSearchTerm] = useState("");
  const [filterType, setFilterType] = useState("å…¨éƒ¨"); // å…¨éƒ¨, åœ¨è·, è·å‰
  const [highlightedCourseId, setHighlightedCourseId] = useState(null);
  
  // è™•ç† chatbot èª²ç¨‹é»æ“Šï¼Œæ»¾å‹•åˆ°å°æ‡‰èª²ç¨‹ä¸¦é«˜äº®
  const handleCourseClick = (courseId) => {
    setHighlightedCourseId(courseId);
    // é—œé–‰ chatbotï¼ˆå¯é¸ï¼‰
    // setIsChatbotOpen(false);
    
    // æ»¾å‹•åˆ°å°æ‡‰çš„èª²ç¨‹å¡ç‰‡
    setTimeout(() => {
      const courseElement = document.getElementById(`course-${courseId}`);
      if (courseElement) {
        courseElement.scrollIntoView({ behavior: "smooth", block: "center" });
        // 3 ç§’å¾Œç§»é™¤é«˜äº®æ•ˆæœ
        setTimeout(() => {
          setHighlightedCourseId(null);
        }, 3000);
      }
    }, 100);
  };
  
  const filteredCourses = COURSES_DATA.filter(course => {
    const matchesSearch = searchTerm === "" || course.title.includes(searchTerm) || course.tags.some(tag => tag.includes(searchTerm));
    const matchesType = filterType === "å…¨éƒ¨" || course.type === filterType;
    return matchesSearch && matchesType;
  });

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 font-sans">
      {/* Navbar */}
      <header className="bg-white shadow-sm sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white">
              <Briefcase size={20} />
            </div>
            <span className="font-bold text-xl tracking-tight text-gray-900">è·æ¥­è¨“ç·´æ•´åˆç¶² <span className="text-blue-600 text-sm font-normal align-top">PRO</span></span>
          </div>
          
          <nav className="hidden md:flex items-center gap-8 text-sm font-medium text-gray-600">
            <a href="#" className="hover:text-blue-600">èª²ç¨‹æŸ¥è©¢</a>
            <a href="#" className="hover:text-blue-600">è£œåŠ©è¨ˆç•«</a>
            <a href="#" className="hover:text-blue-600">è·æ¶¯åœ°åœ–</a>
            <a href="#" className="hover:text-blue-600">å¸¸è¦‹å•ç­”</a>
          </nav>

          <div className="flex items-center gap-4">
            <Bell size={20} className="text-gray-400 hover:text-gray-600 cursor-pointer" />
            <div className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">
              <User size={18} />
            </div>
            <Menu className="md:hidden text-gray-600" />
          </div>
        </div>
      </header>

      {/* Hero Section */}
      <div className="relative bg-gradient-to-r from-blue-700 to-indigo-800 text-white overflow-hidden">
        <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 relative z-10">
          <div className="md:w-2/3">
            <h1 className="text-4xl md:text-5xl font-extrabold mb-6 leading-tight">
              æŠ•è³‡ä½ çš„æœªä¾†ï¼Œ<br/>
              <span className="text-yellow-400">æŠ€èƒ½å‡ç´š</span> å¾ç¾åœ¨é–‹å§‹ã€‚
            </h1>
            <p className="text-lg text-blue-100 mb-8 max-w-xl">
              å½™æ•´å…¨å°æ”¿åºœè£œåŠ©èª²ç¨‹ï¼Œç„¡è«–æ˜¯è½‰è·å°±æ¥­æˆ–åœ¨è·é€²ä¿®ï¼Œæˆ‘å€‘æä¾›æœ€å®Œæ•´çš„å­¸ç¿’è³‡æºèˆ‡è·æ¶¯å°èˆªã€‚
            </p>
            
            {/* Search Bar */}
            <div className="bg-white p-2 rounded-lg shadow-lg flex flex-col md:flex-row gap-2 max-w-2xl">
              <div className="flex-1 flex items-center px-4 bg-gray-50 rounded border border-gray-200">
                <Search className="text-gray-400" size={20} />
                <input 
                  type="text" 
                  placeholder="è¼¸å…¥é—œéµå­—ï¼šPythonã€å’–å•¡ã€è¡ŒéŠ·..." 
                  className="w-full p-3 bg-transparent outline-none text-gray-800 placeholder-gray-400"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
              </div>
              <button className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded font-bold transition-colors">
                æœå°‹èª²ç¨‹
              </button>
            </div>
            
            <div className="mt-6 flex gap-4 text-sm text-blue-200">
              <span>ç†±é–€æœå°‹ï¼š</span>
              <span className="underline cursor-pointer hover:text-white">AI æ‡‰ç”¨</span>
              <span className="underline cursor-pointer hover:text-white">çƒ˜ç„™è­‰ç…§</span>
              <span className="underline cursor-pointer hover:text-white">è‹±æ–‡å•†å‹™</span>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        {/* Filter Tabs */}
        <div className="flex items-center justify-between mb-8">
          <div className="flex items-center gap-4">
            <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
              <BookOpen className="text-blue-600" /> æœ€æ–°é–‹èª²è³‡è¨Š
            </h2>
          </div>
          <div className="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200">
            {["å…¨éƒ¨", "åœ¨è·", "è·å‰"].map(type => (
              <button 
                key={type}
                onClick={(e) => {
                  e.stopPropagation();
                  setFilterType(type);
                }}
                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                  filterType === type 
                  ? "bg-blue-100 text-blue-700" 
                  : "text-gray-500 hover:text-gray-700 hover:bg-gray-50"
                }`}
              >
                {type}è¨“ç·´
              </button>
            ))}
          </div>
        </div>

        {/* Course Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredCourses.map(course => (
            <div 
              id={`course-${course.id}`}
              key={course.id} 
              className={`bg-white rounded-xl shadow-sm border-2 hover:shadow-md transition-all flex flex-col group ${
                highlightedCourseId === course.id 
                  ? 'border-blue-500 shadow-lg ring-4 ring-blue-200' 
                  : 'border-gray-200'
              }`}
            >
              {/* Card Header */}
              <div className="p-5 flex-1">
                <div className="flex justify-between items-start mb-3">
                  <span className={`px-2.5 py-1 rounded text-xs font-bold ${
                    course.type === 'åœ¨è·' 
                    ? 'bg-purple-100 text-purple-700' 
                    : 'bg-green-100 text-green-700'
                  }`}>
                    {course.type}
                  </span>
                  <div className="flex items-center gap-1 text-yellow-500 text-xs font-bold">
                    <Star size={14} fill="currentColor" />
                    {course.rating}
                  </div>
                </div>
                
                <h3 className="text-lg font-bold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors line-clamp-2">
                  {course.title}
                </h3>
                
                <div className="space-y-2 text-sm text-gray-600 mb-4">
                  <div className="flex items-center gap-2">
                    <Calendar size={16} className="text-gray-400" />
                    <span className="truncate">{course.period}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <Clock size={16} className="text-gray-400" />
                    <span className="truncate">{course.time}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <MapPin size={16} className="text-gray-400" />
                    <span className="truncate">{course.location}</span>
                  </div>
                </div>

                <div className="flex flex-wrap gap-2 mt-auto">
                  {course.tags.slice(0, 3).map((tag, i) => (
                    <span key={i} className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">
                      #{tag}
                    </span>
                  ))}
                </div>
              </div>

              {/* Card Footer */}
              <div className="p-4 border-t border-gray-100 bg-gray-50 rounded-b-xl flex items-center justify-between">
                <div>
                  <div className="text-xs text-gray-500">è‡ªä»˜é¡</div>
                  <div className="text-lg font-bold text-gray-900">
                    NT$ {course.price.toLocaleString()}
                  </div>
                </div>
                <button className="flex items-center gap-1 text-blue-600 font-medium hover:text-blue-800 transition-colors">
                  è©³ç´°è³‡è¨Š <ChevronRight size={18} />
                </button>
              </div>
            </div>
          ))}
        </div>

        {filteredCourses.length === 0 && (
          <div className="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
            <div className="text-gray-400 mb-2">ç„¡æ³•æ‰¾åˆ°ç›¸é—œèª²ç¨‹</div>
            <p className="text-sm text-gray-500">è©¦è©¦çœ‹ä¸åŒçš„é—œéµå­—æˆ–ç¯©é¸æ¢ä»¶</p>
          </div>
        )}

      </main>

      {/* Footer */}
      <footer className="bg-gray-800 text-gray-300 py-10 mt-12">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <div className="text-white font-bold text-lg mb-4">è·æ¥­è¨“ç·´æ•´åˆç¶²</div>
            <p className="text-sm">
              å‹å‹•éƒ¨å‹å‹•åŠ›ç™¼å±•ç½²ç‰ˆæ¬Šæ‰€æœ‰<br/>
              æœå‹™å°ˆç·šï¼š0800-777-888
            </p>
          </div>
          <div>
            <h4 className="text-white font-bold mb-4">å¿«é€Ÿé€£çµ</h4>
            <ul className="space-y-2 text-sm">
              <li><a href="#" className="hover:text-white">æ‰¾èª²ç¨‹</a></li>
              <li><a href="#" className="hover:text-white">æ‰¾è£œåŠ©</a></li>
              <li><a href="#" className="hover:text-white">æœ€æ–°æ¶ˆæ¯</a></li>
            </ul>
          </div>
          <div>
            <h4 className="text-white font-bold mb-4">ç›¸é—œè³‡æº</h4>
            <ul className="space-y-2 text-sm">
              <li><a href="#" className="hover:text-white">å°ç£å°±æ¥­é€š</a></li>
              <li><a href="#" className="hover:text-white">ç”¢æ¥­æ–°å°–å…µ</a></li>
              <li><a href="#" className="hover:text-white">é’å¹´è·è¨“</a></li>
            </ul>
          </div>
        </div>
      </footer>

      {/* Chatbot Integration */}
      <ChatBot onCourseClick={handleCourseClick} />
      
    </div>
  );
};

export default App;